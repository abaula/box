Статус документа: Черновик
=====================


Типы данных:

Box - коробка, для хранения документов одного типа, аналог table в СУБД.
Entry - документ
Field - поле документа
Term - содержимое поля документа




Типы файлов для Box:

1. Группа Content

1.1 файл Field.meta

метаданные всех полей документа

формат записи:
- id поля число
- id поля строка
- id поля родителя
- название
- тип данных
- порядок отображения
- описание поля

1.2 файл Term.NN.seg (!! нужен отдельный индекс для работы с содержимым)

Содержит термы.

формат записи:
- длина терма в байтах
- байты терма
- признак deleted

1.3 файл Field.NN.seg

содержит уникальное содержимое для поля данных (!! нужен отдельный индекс для работы с содержимым)

формат записи:
- id поля число
- счётчик документов где используются данные поля
- кол-во термов
- <сортированный массив термов в виде>: [
    файл Term.NN.seg
    кол-во смещений в файле
    <массив смещений в виде>: [
        смещение в файле 1
        смещение в файле n
]]

1.4 файл Data.NN.seg

содержит записи документа

формат записи:
- id документа число
- признак deleted
- <массив полей с термами в виде>: [
    файл Field.NN.seg
    смещение в файле Field.NN.seg
]


2. Группа Index

2.1 файл index.meta

мета данные об индексах для полей

формат записи (строка текста):
- id поля число
- тип индекса (btree, hashTable, ...)
- файлы сегменты индекса


2.2 файл Index.FF.NN.seg Segment (btree)

Содержит btree с термами для поля документа.
Начинается с первой записи root node.

формат записи:
- term segment (файл Term Segment)
- term segment offset (смещение к началу терма в файле Term Segment)
- left index segment (left child - файл Index Segment)
- left index segment offset (left child - смещение к узлу в файле Index Segment)
- right index segment (right child - файл Index Segment)
- right index segment offset (right child - смещение к узлу в файле Index Segment)
- признак deleted


3. Группа Tool

3.1 Segment.stat

статистика по использованию записей в файлах сегментах - где сколько записей помеченных как удалённые

=================================
Структура каталога с данными (в реальном каталоге имена файлов могут быть обезличены - нужен маппинг)

data/
    box.00001/
        field.meta
        field.meta.lock
        segment.stat
        segment.stat.lock
        term.00001.seg
        term.00002.seg
        term.write.lock - синхронизация записи в термы (прим. при реализации строго следить за порядком установки блокировок для избежания deadlock)
        field.00001.seg
        field.00002.seg
        field.write.lock - синхронизация записи в данные полей
        data.00001.seg
        data.00002.seg
        data.00003.seg
        data.write.lock - синхронизация записи в документы
        index.meta
        index.meta.lock - синхронизация записи в мета данные индексов
        index.0001.00000.seg - root node!
        index.0001.00001.seg
        index.0001.00002.seg
        index.0001.write.lock - синхронизация записи в индексы


==============================
